---
title: "Demystifying the Relationship Between Fixed/Random Effects and Unmeasured Confounding in Panel Data Analysis"
author: "Yicheng Shen, Yanjiao Yang, Huiying Lin"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
    - \setlength{\parskip}{0em}
    - \setlength{\parindent}{2em}
    - \usepackage{indentfirst}
    - \usepackage{float}
    # - \usepackage{setspace}\onehalfspacing
output: 
  pdf_document: 
    extra_dependencies: ["float"]
    number_sections: true
bibliography: SYL.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache = F, warning = F, message = F)
library(tidyverse)
library(lme4)
library(ggplot2)
library(gridExtra)
library(kableExtra)
library(GGally)
ggplot2::theme_set(ggplot2::theme_bw())
knitr::opts_chunk$set(fig.align = 'center')
knitr::opts_chunk$set(fig.pos = "H")

load("bias_result_full.RData")
```


\section{Introduction}

Panel data analysis is a widely used statistical tool in econometrics, ecology and broader social sciences to study the relationships between variables and reveal the effects of particular treatments over time. However, this type of analysis is often susceptible to confounding variables, which can bias the estimated coefficients and distort the causal interpretation of the results. 
Fixed and random effects models frequently emerge in the panel data analysis to account for latent confounding variables that are time-invariant [@gunasekara2014fixed] or time-varying [@li2011nonpara; @ahn2013panel]. 
A common belief among econometricians is that fixed effects (FE) or random effects (RE) models can absorb unmeasured confounding variables [@angrist2009mostly], but the mechanism behind this claim is mysterious and not well-understood. 
In this research paper, we aim to explore the relationship between fixed/random effects and the problem of unmeasured confounding in panel data analysis and provide insights into whether and in what sense these models can address this issue.

Based on the results of our simulations, we found that the implementation of fixed/random effects models can, to a certain extent, address the presence of unmeasured confounding. However, there remains some systematic bias due to the correlations and interactions between the unmeasured confounder and the treatment assignment or time. Specifically, factors such as the size, time span and treatment time points of the panel data, the magnitude of the unmeasured confounding, and the extent to which it impacts both the treatment and the outcome all play important roles in influencing the degree of bias present in the causal estimations from fixed/random effects models.



\section{Background}

In typical observational studies, failing to capture significant unmeasured confounding gives rise to biased estimates of treatment effects, which compels practitioners to develop methods of assessing and handling any potential unmeasured confounding [@vanderweele2011unmeasured]. 
The question of whether fixed/random effects models can account for unmeasured confounding in panel data analysis has been the subject of much debate particularly in the econometrics literature. 
A number of studies have explored this issue from different angles and with varying degrees of empirical evidence.

One line of research has focused on theoretical arguments for why fixed/random effects models might be effective at absorbing unmeasured confounding. 
For example, @angrist2009mostly discuss the FE strategies that use data with a time or cohort dimension to control for unobserved-but-fixed omitted variables.
@hausman1981panel argue that fixed effects models can control for the time-invariant confounders by essentially differencing them out, while random effects models can account for time-varying confounders that are uncorrelated with the fixed effects. More recently, @wooldridge2010econometric has suggested that fixed effects models can be viewed as a form of quasi-experimental design that mimics a randomized controlled trial, and thus can address the unobserved component to the extent that such designs do.

Other scholars have openly challenged the notion that fixed/random effects models can fully absorbing unmeasured confounding. For example, @mundlak1978pooling once argued that random effects models are biased when unobserved heterogeneity is correlated with observed variables, and that fixed effects models are limited by the fact that they cannot separately estimate time-invariant unmeasured confoundings. 
@hazlett2022understanding point out that random effect estimates in multilevel models are equivalent to fixed effects estimates that have been shrunken through a regularization process. When the source of unmeasured confounders is at the group-level, the FE approach could unbiasedly estimate treatment effects, but with poor estimates of standard errors. Bias takes place in random effects models because their variables are not “allowed” to adjust for confounding as intended and thus fails to remove the unmeasured confounding.
Furthermore, @bell2015explaining note that while fixed effects models can provide reasonable estimates of treatment effects, they may still suffer from omitted variable bias if the unobserved confounding variable is correlated with the time-varying variables.

Therefore, the effectiveness of fixed/random effects models in accounting for unmeasured confounding and obtaining unbiased estimates of treatment effects in panel data analysis remains a topic of ongoing research and debate.
As such, our project seeks to unravel the trends of potential bias, if it exists, when applying fixed/random effects models in the events of unmeasured confounding.



\section{Method}

In this project, we investigate our research question through a series of simulation studies, with the aim of demonstrating the degree to which the fixed/random effects models estimate causal effects that align with the truth. Moreover, we also want to identify any contributing factors that could impact the magnitude of bias in these estimations.

```{r DAG, fig.cap="\\label{fig:causal_DAG} Visualize the data structure and the problem of unmeasured confoudning using a causal DAG.",out.width="61%"}
knitr::include_graphics("Image/DAG.png")
```

While many previous work presume that specifying an intercept for every individual in the study (using either FE or RE model) is an appropriate method to address any unmeasured confoundings, the proposed methods either have strict assumptions or do not seem to take into account of the relationship and possible interactions between the unmeasured confounding and the treatment or time. As portrayed in the DAG of Figure \ref{fig:causal_DAG}, it is rarely the case that the unmeasured confounder affects the outcome alone. In fact, there is usually time-varying unmeasured confounder that exerts effects on both the treatment assignments and the outcomes in real-life panel data [@imbens2021controlling]. 

\subsection{Data Generation Process}

We restrict our main discussion about artificial panel data with binary treatment assignments and continuous confoundings and outcomes. Our data generation process (DGP) uses the following specifications as the true model behind the scene:
<!-- E\left(\mathrm{Y}_{i t} \mid A_i, \mathrm{X}_{i t}, t, \mathrm{D}_{i t}\right)& =\alpha+\lambda_t+\rho \mathrm{D}_{i t}+ \gamma A_i+ \delta \mathrm{X}_{i t} \\ -->
$$
\begin{aligned}
Y_{it} &= \alpha+\lambda_t+ \delta \mathrm{X}_{i t}+\rho \mathrm{D}_{i t}+ \gamma A_i+\phi \mathrm{D}_{i t} A_i+\beta \lambda_{t} A_i +\epsilon_{it} \\
\end{aligned}
$$

In our most basic DGP setup of artificial panel data, there are `N` = 100 individuals and `T` = 10 time points. We also designate `T-treat` as the half time ($\frac{T}{2}$), when the binary treatment is given to those in the treatment group. 
Each individual has $X_i \overset{i.i.d}{\sim} \text{Uniform(0, 10)}$ as their average covariate. $X_{it}$, for each individual at each timepoint is then simulated from $N(X_i,1)$. 
The unmeasured counfounding, $A_i$, is either from $N(0,1)$ or $\text{Uniform(0,1)}$. Notice that $A_i$ is a latent, unit-specific trait that is only used in data generation and unobservable during modeling fitting.  

We designed two ways that the unmeasured confounding, $A_i$, could affect the treatment assignment, $D_{it}$: First, as $A_i\sim N(0,1)$ is above or below a certain cut-off point, the probability of receiving the treatment changes to respective values. This is controllable since we can adjust the respective values to be widely apart (`strong` influence of A on D) or to be close (`small` influence of A on D).
Second, $A_i\sim \text{Uniform}(0,1)$ directly serves as the probability of receiving the treatment. We regard this as more direct influence of A on D.  

In addition, we considered the potential interaction effects from unmeasured confounding and treatment on the outcome. There are three specifications of this interaction term: (1) $\phi A_i D_{it}$, (2) $\phi A_i^2 D_{it}$ and (3) $\phi \frac{ 1}{A_i}D_{it}$, which cover the identity, square and inverse transformation of unmeasured confounding. Similarly, we also simulated the time-varying unmeasured confounding case, which is parameterized by an interaction term of $\lambda_{t} A_i$, allowing the effect of unmeasured confounding on the outcome to vary through time. 

\ 

The outcome variable, $Y_{it}$, is thus continuous and generated from the linear model including: 

* The true coefficient for covariate, $\delta$, is chosen arbitrarily as 1 or 5. 

* The true treatment/causal effect, i.e. the coefficient of treatment status, $\rho$, could vary from to 1 to 20.

* The true coefficient of unmeasured confounding, $\gamma$, could vary from to 0 to 20, with zero meaning that there is no direct effect of unmeasured confounding on the outcome. 

* The true coefficient of the interaction, $\phi$, between the treatment and the unmeasured confounding could vary from to 0 to 10, with zero meaning that there is no interaction of treatment effect. 

* The true coefficient of the interaction, $\beta$, between the time and the unmeasured confounding could vary from to 0 to 10, with zero meaning that the effect of A is time-invariant. 

* The noise term, $\epsilon_{it}$, is set to follow $\epsilon_{it} \overset{i.i.d}\sim N(0,1)$. 


\subsection{Estimators}

There are several distinct methods that allow for estimations of treatment effects. Our primary objective is to assess the performance of these models under a range of diverse circumstances.

\ 

***Difference-in-difference (DID) estimator***: The Difference-in-Differences (DID) method is a quasi-experimental approach used to estimate the causal effect of a treatment in panel data. Its formulation could be viewed using the difference between the "Before-after (BA)" estimators of treatment and of control groups, which makes it easier and faster to calculate than regression-based models. Nevertheless, adding time-varying covariates and interaction terms are easier to do in parametric models rather than DID.  

$$
\begin{aligned}
\tau^{DID} &= (\bar Y_{1, t+1} - \bar Y_{1, t}) - (\bar Y_{0, t+1} - \bar Y_{0, t}) =\hat\tau^{BA}_1-\hat\tau^{BA}_0
\end{aligned}
$$


***OLS model***: The basic form of OLS model is very likely to be vulnerable to severe bias since it does not remedy unmeasured confounding or potential interactions. 

$$
\begin{aligned}
Y_{it} &= \alpha+\lambda_t+\rho \mathrm{D}_{i t}+ \delta \mathrm{X}_{i t}+ \epsilon_{it} 
\end{aligned}
$$


***Fixed effects (FE) model***: The formulation and validity of the fixed effects model are discussed extensively in the literature. Despite that, whether the individual intercepts can fully absorb all types of unmeasured components (including interactions with treatment or time) remains questionable.   

$$
\begin{aligned}
\alpha_i &\equiv \alpha+ \gamma A_i\\
Y_{it} &= \alpha_i+\lambda_t+\rho \mathrm{D}_{i t}+ \delta \mathrm{X}_{i t}+ \epsilon_{it} 
\end{aligned}
$$


***Random effects (RE/RI) model***: The random effects model is essentially a random intercept (RI) model. The argument that RI could account for unmeasured confounding is theoretically problematic due to its modeling specification. 
In particular, bias emerges when the random effects are correlated with the treatment. Because the group-specific intercepts in a RI model are regularized, they do not achieve the values that would “fully absorb” group-specific confounding, leaving components unexplained that can instead be captured by FE [@hazlett2022understanding]. 

$$
\begin{aligned}
Y_{it} &= \alpha_i+\lambda_t+\rho \mathrm{D}_{i t}+ \delta \mathrm{X}_{i t}+ \epsilon_{it} \\
& \text{where } \alpha_i | D, X \overset{i.i.d}\sim N(\mu, \sigma^2)
\end{aligned}
$$

As shown by @hazlett2022understanding, there is an equivalence between RI and regularized FE models. Moreover, it is further shown that a bias-corrected version of RE model with group-level means of $D_{it}$ could account for unit-specific unmeasured confounding in the same way that FE would: 

$$
\begin{aligned}
Y_{it} &= \alpha_i+\lambda_t+\rho \mathrm{D}_{i t} + \rho' \mathrm{\bar D}_{i} + \delta \mathrm{X}_{i t}+ \epsilon_{it} \\
& \text{where } \alpha_i | D, X \overset{i.i.d}\sim N(\mu, \sigma^2)
\end{aligned}
$$

We use `lm` to fit OLS and fixed effects models and `lmer` from the `lme4` package to fit the random intercept model using REML. The frequentist way of fitting random intercept models is commonly employed and faster to compute, though it may not have as robust uncertainty quantification as the Bayesian hierarchical models.  

<!-- \subsection{Binary Case} -->

<!-- FE: logit(Y) = ... -->

<!-- RE: `glmer` from the `lme4` -->


\section{Results}

For each of the setting and estimator described above, we compute an average estimate, bias and 95% confidence interval of the treatment effect based on 1000 simulations of data generation and model fitting. There are some interesting results elaborated below (all visualizations referred are in the appendix section). 

\subsection{No interaction and no time-varying unmeasured confounders}

First of all, Figure \ref{fig:all_bias_with_ols} describes the average bias of estimated treatment effects from DID, FE, OLS, and RE estimation methods under three degrees to which A affects D with `N` = 100, `T` = 10 and `T-treat` = 5. DID and FE model give unbiased estimates, while the OLS model has the largest bias. Specifically, as the effect of A on D increases, both the OLS and RE bias increase. As $\rho$ increases, each bias fluctuates at a steady level with DID bias $\approx$ FE bias < RE bias < OLS bias holding true.

Figure \ref{fig:bias_with_t} shows the distribution of bias across varying total time points. 
With no interaction and no time-varying unmeasured confounders, FE model still provides an unbiased estimate, while RE model has higher bias and OLS model gives the largest bias. Notably, as the number of time points (`T`) increases, the RE bias decreases, which may result from increasing number of data points.

Figure \ref{fig:bias_with_t_treat} presents distribution of bias across varying treatment time points with `T` = 20. 
Similarly, FE model gives unbiased estimate, RE model has higher bias, and OLS has the most bias. 
As the treatment time points increases from 3 to 18, bias of RE model decreases.

In Figure \ref{fig:bias_with_gamma}, we show distribution of bias across varying unmeasured confounding coefficients. 
FE model gives unbiased estimate. As $\gamma$, the coefficient by which unmeasured confounders affect outcome increases, bias of OLS and RE model both increases, and bias of OLS model increases rapidly.

Figure \ref{fig:bias_with_rho} shows distribution of bias across varying true causal effects. 
Under different values of $\rho$ by which treatment affects outcome, bias of the three models does not change.


\subsection{With interaction and time-varying unmeasured confounders}

Figure \ref{fig:bias_interaction} demonstrates that even fixed effects models are not able to estimate the treatment effects unbiasedly when there are interaction terms between the unmeasured confounding and treatment assignment or time. 
Specifically, Figure \ref{fig:bias_AD_interaction} presents the distribution of bias under different $\phi$ and three types of interactions ($\phi A_i D_{it}$, $\phi A_i^2 D_{it}$ and $\phi \frac{ 1}{A_i}D_{it}$). 
Under the same type of interaction, all three biases increase as $\phi$ increases, with FE bias < RE bias < OLS bias always holding true. 
The deviation of the FE bias from 0 is reasonable since the FE model assumes $$\alpha_i = \alpha+A_i(\gamma+\phi D_{it})$$

When $\phi$ is large, fixed effects can no longer absorb the unmeasured confounders, which results in the biased estimate.

A similar pattern is displayed in Figure \ref{fig:bias_AT_interaction}, where the three types of bias increase as $\beta$ increases under fixed time points $T$. The bias behavior is reasonable because the FE model assumes $$\alpha_i = \alpha+A_i(\gamma+\beta \lambda_{t})$$

Large $\beta$ makes it more challenging for fixed effects to absorb unmeasured confounders. Longer measured time points also exacerbate the bias due to the $A_i \lambda_t$ interaction. 

In addition, we also show in Figure \ref{fig:CI_interaction} that the coverage of 95% CI of treatment effect estimates drops sharply as we allow the unmeasured confounding to be time-varying and interacts with the treatment, implying that the estimators are far from being consistent under these settings. 


\subsection{Bias-corrected random effects model}

Figure \ref{fig:bias_correct_RE} and Figure \ref{fig:bias_BiasCorrect_inter} demonstrates the performance of the bias-corrected RE model with group-level treatment means. Figure \ref{fig:bias_correct_RE} shows the distribution of bias from FE and bias-corrected RE model when true model doesn't have interaction. FE and bias-corrected RE models both give unbiased estimate under different values of $\gamma$. Figure \ref{fig:bias_BiasCorrect_inter} shows the distribution of bias from OLS, FE, and bias-corrected RE model across different coefficients of interactions. As the interaction coefficient increases, bias from the three models all increases. OLS model has the largest bias as before, and FE and bias-corrected RE model have similar bias lower than that from OLS model.



\section{Discussion}

We have described and presented the relationship between fixed/random effects and unmeasured confounding in panel data. The simulation result suggests that using fixed/random effects models can partly tackle the issue of unmeasured confounding. Specifically, when there is no interaction between unmeasured confounding and treatment/time, FE model gives approximately unbiased estimate, while RE model has biased estimate. Nevertheless, the fixed effects are unable to absorb the unmeasured confounding when the interaction exists, which result in the biased estimate. By exploring the performance of bias corrected random effects model with group level treatment means, we have found that BCRE model improves the performance of RE model and has similar bias to the FE model.

When unmeasured confounder is time-varying and interacts with treatment assignment, the closed form of the asymptotic bias is complicated to derive, particularly for RE models. Nevertheless, @li2020impact detailedly illustrates the closed form of bias in the presence of unmeasured within- and/or between-cluster confounders when the treatment is continuous. 
Particularly, the formula suggests a positive linear relationship between the coefficient of unmeasured confounder and the bias. However, under a different assumption that the treatment is binary, this paper presents a slightly different pattern that the RE bias first increases and then decreases as coefficient of unmeasured confounder $\gamma$ grows larger. 
More work can be done regarding the closed form of bias under binary treatment and will be helpful for obtaining insights of asymptotic behavior of the bias.

We outline the following aspects as future research directions: Firstly, fixed/random effects models do not estimate the strength of unmeasured confounders as latent variable on the outcome. Other models including instrumental variable (IV) may be able to address the inadequacy.
Secondly, we have tried binary outcome which presents a similar behavior to the simulation. It is possible to conduct more simulations for binary confounders because the real-word latent variable could be binary traits.
Thirdly, the time-varying confounders in this paper is set to change linearly with time. Future work can specify more sophisticated time-varying confounders. 
Fourthly, the coefficient of treatment is set to be fixed constant. Future work can specify more complicated treatment effect which may change with time. 
Finally, three types of interactions between confounders and treatment is considered in this paper, more variations may be explored next.  

Overall, our project, along with many literatures, suggests that while fixed/random effects models may be useful in controlling for unmeasured confounding in panel data analysis, they are not a panacea. Other methods, such as instrumental variables or regression discontinuity designs, may be more necessary in certain cases to fully address this issue.


\newpage


\section{Appendix}

All three team members contribute to the write up of this project. 

For more technical details including all of our R codes, simulated data and results, feel free to visit our Github repo: https://github.com/sheny2/STA-640. 

```{r With OLS, fig.cap="\\label{fig:all_bias_with_ols} Average bias of estimated treatment effects from four types of estimation methods under N = 100, T = 10 and T-treat = 5, faceted by the degree to which A affects D.",fig.height=6, fig.width=11, out.width="95%", eval = T}
load("result_data/bias_result_interaction_gamma.RData")
# gridExtra::grid.arrange(
# bias_result_full %>% pivot_longer(cols = c("DID_bias","OLS_bias","FE_bias", "RE_bias"), names_to = "Bias_Type", values_to = "Bias") %>%
#   filter(rho == 5) %>%
#   ggplot(aes(x = gamma, y = Bias, color = Bias_Type)) + geom_point() + geom_line() + facet_wrap(~confound_treatment) + labs(x = expression(gamma))
# ,
# bias_result_full %>% pivot_longer(cols = c("DID_bias","OLS_bias","FE_bias", "RE_bias"), names_to = "Bias_Type", values_to = "Bias") %>%
#   filter(gamma == 5) %>%
#   ggplot(aes(x = rho, y = Bias, color = Bias_Type)) + geom_point() + geom_line() + facet_wrap(~confound_treatment) + labs(x = expression(rho)) )

bias_result_interaction_gamma$confound_treatment = factor(bias_result_interaction_gamma$confound_treatment)
levels(bias_result_interaction_gamma$confound_treatment)[levels(bias_result_interaction_gamma$confound_treatment)=="Small"] <- "Small effect of A on D"
levels(bias_result_interaction_gamma$confound_treatment)[levels(bias_result_interaction_gamma$confound_treatment)=="Strong"] <- "Strong effect of A on D"
levels(bias_result_interaction_gamma$confound_treatment)[levels(bias_result_interaction_gamma$confound_treatment)=="Very Strong"] <- "p = A ~ Uniform(0,1)"

bias_result_full$confound_treatment = factor(bias_result_full$confound_treatment)
levels(bias_result_full$confound_treatment)[levels(bias_result_full$confound_treatment)=="Small"] <- "Small effect of A on D"
levels(bias_result_full$confound_treatment)[levels(bias_result_full$confound_treatment)=="Strong"] <- "Strong effect of A on D"
levels(bias_result_full$confound_treatment)[levels(bias_result_full$confound_treatment)=="Very Strong"] <- "p = A ~ Uniform(0,1)"

gridExtra::grid.arrange(
bias_result_interaction_gamma %>% pivot_longer(cols = c("DID_bias","OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias") %>%
  filter(gamma < 2) %>% ggplot(aes(x = gamma, y = Bias, color = Model)) + geom_point() + geom_line() + facet_wrap(~confound_treatment) + labs(x = expression(gamma))
,
bias_result_full %>% pivot_longer(cols = c("DID_bias","OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias") %>%
  filter(gamma == 1) %>% ggplot(aes(x = rho, y = Bias, color = Model)) + geom_point() + geom_line() + facet_wrap(~confound_treatment) + labs(x = expression(rho))
)
```

```{r Without OLS, fig.cap="\\label{fig:all_bias_without_ols} Compareing average bias of estimated treatment effects from DID, FE, and RE models under N = 100, t = 10 and t-treat = 5, faceted by degree to which A affects D.",fig.height=6, fig.width=11, out.width="85%", eval = F}
gridExtra::grid.arrange(
bias_result_full %>% pivot_longer(cols = c("DID_bias","OLS_bias","FE_bias", "RE_bias"), names_to = "Bias_Type", values_to = "Bias") %>%
  filter(Bias_Type != "OLS_bias", rho == 5) %>% 
  ggplot(aes(x = gamma, y = Bias, color = Bias_Type)) + geom_point() + geom_line() + facet_wrap(~confound_treatment) + labs(x = expression(gamma))
,
bias_result_full %>% pivot_longer(cols = c("DID_bias","OLS_bias","FE_bias", "RE_bias"), names_to = "Bias_Type", values_to = "Bias") %>%
  filter(Bias_Type != "OLS_bias", gamma == 5) %>%
  ggplot(aes(x = rho, y = Bias, color = Bias_Type)) + geom_point() + geom_line()  + facet_wrap(~confound_treatment) + labs(x = expression(rho))
)
```


```{r n_of_time, fig.cap="\\label{fig:bias_with_t} Distribution of bias across varying total time points. Starting from here and the following figures, N = 50 and all coeffiients are 1 unless specified otherwise.", fig.width=10, fig.height=3.5,out.width="88%"}
load("result_data/result_5_3_gamma1_phi0.RData")
load("result_data/result_10_5_gamma1_phi0.RData")
load("result_data/result_30_15_gamma1_phi0.RData")
load("result_data/result_50_25_gamma1_phi0.RData")
gridExtra::grid.arrange(
  result_5_3_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias"))) %>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.5,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "T = 5, T-treat = 3"),
result_10_5_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.5,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "T = 10, T-treat = 5"), 
result_30_15_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.5,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "T = 30, T-treat = 15"), 
result_50_25_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.5,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "T = 50, T-treat = 25"),nrow = 1)
```



```{r n_of_time_treat, fig.cap="\\label{fig:bias_with_t_treat} Distribution of bias across varying treatment time points.", fig.width=10, fig.height=3.5, out.width="88%"}
load("result_data/result_20_3_gamma1_phi0.RData")
load("result_data/result_20_8_gamma1_phi0.RData")
load("result_data/result_20_13_gamma1_phi0.RData")
load("result_data/result_20_18_gamma1_phi0.RData")

gridExtra::grid.arrange(
  result_20_3_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
    mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.8,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "T = 20, T-treat = 3"),
result_20_8_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.8,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "T = 20, T-treat = 8"), 
result_20_13_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.8,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "T = 20, T-treat = 13"), 
result_20_18_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.8,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "T = 20, T-treat = 18"),nrow = 1)
```



```{r bias_gamma, fig.cap="\\label{fig:bias_with_gamma} Distribution of bias across unmeasured confounding coefficients.", fig.width=10, fig.height=3.5, out.width="88%"}
load("result_data/result_10_5_gamma1_phi0.RData")
load("result_data/result_10_5_gamma2_phi0.RData")
load("result_data/result_10_5_gamma3_phi0.RData")
load("result_data/result_10_5_gamma5_phi0.RData")
load("result_data/result_10_5_gamma10_phi0.RData")
load("result_data/result_10_5_gamma15_phi0.RData")

load("result_data/result_10_5_gamma0_phi0.RData")
load("result_data/result_10_5_gamma01_phi0.RData")
load("result_data/result_10_5_gamma03_phi0.RData")
load("result_data/result_10_5_gamma05_phi0.RData")

gridExtra::grid.arrange(
  result_10_5_gamma01_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~" = 0.1")),
result_10_5_gamma05_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~" = 0.5")),
result_10_5_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~" = 1")),
result_10_5_gamma2_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~" = 2")),nrow = 1)


# gridExtra::grid.arrange(
#   result_10_5_gamma3_phi0 %>% as_tibble() %>%
#   pivot_longer(cols = c("FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
#   mutate(Model = factor(Model))%>% 
#   mutate(Model = factor(Model, levels = c("FE_bias", "RE_bias")))%>% 
#   ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~"= 3")),
# result_10_5_gamma5_phi0 %>% as_tibble() %>%
#   pivot_longer(cols = c("FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
#   mutate(Model = factor(Model))%>% 
#   mutate(Model = factor(Model, levels = c("FE_bias", "RE_bias")))%>%
#   ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~"= 5")),
# result_10_5_gamma10_phi0 %>% as_tibble() %>%
#   pivot_longer(cols = c("FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
#   mutate(Model = factor(Model))%>% 
#   mutate(Model = factor(Model, levels = c("FE_bias", "RE_bias")))%>%
#   ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~"= 10")),
# result_10_5_gamma15_phi0 %>% as_tibble() %>%
#   pivot_longer(cols = c("FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
#   mutate(Model = factor(Model))%>% 
#   mutate(Model = factor(Model, levels = c("FE_bias", "RE_bias")))%>%
#   ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~"= 15")),nrow = 1)
```



```{r bias_rho, fig.cap="\\label{fig:bias_with_rho} Distribution of bias across true causal effects", fig.width=10, fig.height=3.5, out.width="88%"}
load("result_data/result_10_5_gamma1_rho1.RData")
load("result_data/result_10_5_gamma1_rho3.RData")
load("result_data/result_10_5_gamma1_rho5.RData")
load("result_data/result_10_5_gamma1_rho7.RData")

gridExtra::grid.arrange(
  result_10_5_gamma1_rho1 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
    mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-.7,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(rho~" = 1")),
result_10_5_gamma1_rho3 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-.7,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(rho~" = 3")),
result_10_5_gamma1_rho5 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-.7,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(rho~" = 5")),
result_10_5_gamma1_rho7 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-.7,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(rho~" = 7")), nrow = 1)
```


```{r bias_interaction, fig.cap="\\label{fig:bias_interaction} Distribution of bias across coefficients of interactions.", fig.width=11, fig.height=6, out.width="90%"}
load("result_data/bias_result_interaction_phi.RData")
load("result_data/bias_result_interaction_beta.RData")

bias_result_interaction_phi$confound_treatment = factor(bias_result_interaction_phi$confound_treatment)
levels(bias_result_interaction_phi$confound_treatment)[levels(bias_result_interaction_phi$confound_treatment)=="Small"] <- "Small effect of A on D"
levels(bias_result_interaction_phi$confound_treatment)[levels(bias_result_interaction_phi$confound_treatment)=="Strong"] <- "Strong effect of A on D"
levels(bias_result_interaction_phi$confound_treatment)[levels(bias_result_interaction_phi$confound_treatment)=="Very Strong"] <- "p = A ~ Uniform(0,1)"

bias_result_interaction_beta$confound_treatment = factor(bias_result_interaction_beta$confound_treatment)
levels(bias_result_interaction_beta$confound_treatment)[levels(bias_result_interaction_beta$confound_treatment)=="Small"] <- "Small effect of A on D"
levels(bias_result_interaction_beta$confound_treatment)[levels(bias_result_interaction_beta$confound_treatment)=="Strong"] <- "Strong effect of A on D"
levels(bias_result_interaction_beta$confound_treatment)[levels(bias_result_interaction_beta$confound_treatment)=="Very Strong"] <- "p = A ~ Uniform(0,1)"

gridExtra::grid.arrange(
bias_result_interaction_phi %>% 
  filter(phi <= 10) %>% 
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot(aes(x = phi, y = Bias, color = Model)) + geom_point() + geom_line() + labs(title = "Bias with interaction between unmeasured confounding and treatment", x = expression(phi)) + facet_wrap(~confound_treatment), 
bias_result_interaction_beta %>%   
  filter(beta <= 10) %>% 
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot(aes(x = beta, y = Bias, color = Model)) + geom_point() + geom_line() + labs(title = "Bias with interaction between unmeasured confounding and time", x = expression(beta)) + facet_wrap(~confound_treatment))
```

```{r CI_interaction, fig.cap="\\label{fig:CI_interaction} 95 percentage CI coverage of treatment effect estimate across coefficients of interactions.", fig.width=11, fig.height=6, out.width="90%"}
gridExtra::grid.arrange(
bias_result_interaction_phi %>% 
  filter(phi <= 10) %>% 
  pivot_longer(cols = c("OLS_CI","FE_CI", "RE_CI"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_CI","FE_CI", "RE_CI")))%>% 
  mutate(Model = recode(Model, OLS_CI = 'OLS',FE_CI = 'FE',RE_CI = 'RE'))%>% 
  ggplot(aes(x = phi, y = Bias, color = Model)) + geom_point() + geom_line() + labs(title = "95% CI Coverage of treatment effect estimate under interaction between unmeasured confounding and treatment", x = expression(phi)) + facet_wrap(~confound_treatment), 
bias_result_interaction_beta %>%   
  filter(beta <= 10) %>% 
  pivot_longer(cols = c("OLS_CI","FE_CI", "RE_CI"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_CI","FE_CI", "RE_CI")))%>% 
  mutate(Model = recode(Model, OLS_CI = 'OLS',FE_CI = 'FE',RE_CI = 'RE'))%>% 
  ggplot(aes(x = beta, y = Bias, color = Model)) + geom_point() + geom_line() + labs(title = "95% CI Coverage of treatment effect estimate under interaction between unmeasured confounding and time", x = expression(beta)) + facet_wrap(~confound_treatment), nrow = 2)
```

```{r bias_interactions, fig.cap="\\label{fig:bias_AD_interaction} Distribution of bias across coefficients of interactions.", fig.width=12, fig.height=9, out.width="80%"}
load("result_data/result_5_3_gamma3_phi0.RData")
load("result_data/result_5_3_gamma3_phi1.RData")
load("result_data/result_5_3_gamma3_phi3.RData")
load("result_data/result_5_3_gamma3_phi5.RData")

load("result_data/result_5_3_gamma3_phi0sq.RData")
load("result_data/result_5_3_gamma3_phi1sq.RData")
load("result_data/result_5_3_gamma3_phi3sq.RData")
load("result_data/result_5_3_gamma3_phi5sq.RData")

load("result_data/result_5_3_gamma3_phi0inv.RData")
load("result_data/result_5_3_gamma3_phi1inv.RData")
load("result_data/result_5_3_gamma3_phi3inv.RData")
load("result_data/result_5_3_gamma3_phi5inv.RData")

gridExtra::grid.arrange(
 result_5_3_gamma3_phi0inv %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 0, Interaction: 1/A*D")),
result_5_3_gamma3_phi1inv %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,10) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 1, Interaction: 1/A*D")),
result_5_3_gamma3_phi3inv %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,10) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 3, Interaction: 1/A*D")),
result_5_3_gamma3_phi5inv %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,10) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 5, Interaction: 1/A*D")),

 result_5_3_gamma3_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
   mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 0, Interaction: A*D")),
result_5_3_gamma3_phi1 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 1, Interaction: A*D")),
result_5_3_gamma3_phi3 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 3, Interaction: A*D")),
result_5_3_gamma3_phi5 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 5, Interaction: A*D")),

 result_5_3_gamma3_phi0sq %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 0, Interaction: A^2*D")),
result_5_3_gamma3_phi1sq %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 1, Interaction: A^2*D")),
result_5_3_gamma3_phi3sq %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 3, Interaction: A^2*D")),
result_5_3_gamma3_phi5sq %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 5, Interaction: A^2*D")), nrow = 3)
```


```{r bias_interactions_AT, fig.cap="\\label{fig:bias_AT_interaction} Distribution of bias across coefficients of interaction between unmeasured confounding and time.", fig.width=12, fig.height=7, out.width="80%"}
load("result_data/result_5_3_gamma1_beta1.RData")
load("result_data/result_5_3_gamma1_beta3.RData")
load("result_data/result_5_3_gamma1_beta5.RData")
load("result_data/result_10_5_gamma1_beta0.RData")
load("result_data/result_10_5_gamma1_beta1.RData")
load("result_data/result_10_5_gamma1_beta3.RData")
load("result_data/result_10_5_gamma1_beta5.RData")

gridExtra::grid.arrange(
 result_5_3_gamma3_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "Time-invariant A, T = 5"),
result_5_3_gamma1_beta1 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(beta~" = 1, T = 5")),
result_5_3_gamma1_beta3 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,12) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(beta~" = 3, T = 5")),
result_5_3_gamma1_beta5 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,18) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(beta~" = 5, T = 5")), 

 result_10_5_gamma1_beta0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>%
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = "Time-invariant A, T = 10"),
result_10_5_gamma1_beta1 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(beta~" = 1, T = 10")),
result_10_5_gamma1_beta3 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,12) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(beta~" = 3, T = 10")),
result_10_5_gamma1_beta5 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "RE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "RE_bias")))%>% 
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',RE_bias = 'RE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,18) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(beta~" = 5, T = 10")), nrow = 2)
```


```{r bias_correct, fig.cap="\\label{fig:bias_correct_RE} Distribution of bias via FE and Bias-corrected RE (No interaction in true model).", fig.width=10, fig.height=3.5, out.width="88%"}
load("result_data/BC_result_10_5_gamma01_phi0.RData")
load("result_data/BC_result_10_5_gamma05_phi0.RData")
load("result_data/BC_result_10_5_gamma1_phi0.RData")
load("result_data/BC_result_10_5_gamma2_phi0.RData")

gridExtra::grid.arrange(
  BC_result_10_5_gamma01_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("FE_bias", "BCRE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("FE_bias", "BCRE_bias")))%>%
  mutate(Model = recode(Model, FE_bias = 'FE',BCRE_bias = 'BCRE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~" = 0.1")),
BC_result_10_5_gamma05_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("FE_bias", "BCRE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("FE_bias", "BCRE_bias")))%>%
  mutate(Model = recode(Model, FE_bias = 'FE',BCRE_bias = 'BCRE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~" = 0.5")),
BC_result_10_5_gamma1_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("FE_bias", "BCRE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("FE_bias", "BCRE_bias")))%>%
  mutate(Model = recode(Model, FE_bias = 'FE',BCRE_bias = 'BCRE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~" = 1")),
BC_result_10_5_gamma2_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("FE_bias", "BCRE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("FE_bias", "BCRE_bias")))%>%
  mutate(Model = recode(Model, FE_bias = 'FE',BCRE_bias = 'BCRE'))%>%  
  ggplot() + geom_boxplot(aes(x = Model, y = Bias)) + ylim(-0.6,1) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(gamma~" = 2")),nrow = 1)
```

```{r bias_inter_BC, fig.cap="\\label{fig:bias_BiasCorrect_inter} Distribution of bias across coefficients of interactions, with RE model being bias corrected.", fig.width=10, fig.height=3.5, out.width="88%"}
load("result_data/BC_result_5_3_gamma3_phi0.RData")
load("result_data/BC_result_5_3_gamma3_phi1.RData")
load("result_data/BC_result_5_3_gamma3_phi3.RData")
load("result_data/BC_result_5_3_gamma3_phi5.RData")

gridExtra::grid.arrange(
 BC_result_5_3_gamma3_phi0 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "BCRE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "BCRE_bias")))%>%
   mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',BCRE_bias = 'BCRE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 0, Interaction: A*D")),
BC_result_5_3_gamma3_phi1 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "BCRE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "BCRE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',BCRE_bias = 'BCRE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 1, Interaction: A*D")),
BC_result_5_3_gamma3_phi3 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "BCRE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "BCRE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',BCRE_bias = 'BCRE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 3, Interaction: A*D")),
BC_result_5_3_gamma3_phi5 %>% as_tibble() %>%
  pivot_longer(cols = c("OLS_bias","FE_bias", "BCRE_bias"), names_to = "Model", values_to = "Bias")%>% 
  mutate(Model = factor(Model))%>% 
  mutate(Model = factor(Model, levels = c("OLS_bias","FE_bias", "BCRE_bias")))%>%
  mutate(Model = recode(Model, OLS_bias = 'OLS',FE_bias = 'FE',BCRE_bias = 'BCRE'))%>% 
  ggplot() + geom_boxplot(aes(x = Model, y = Bias))+ ylim(-0.5,5) + geom_hline(yintercept=0, linetype="dashed",color = "RED") + labs(title = expression(phi~" = 5, Interaction: A*D")), nrow = 1)
```

\ 

\ 

\ 

\ 


\section{Reference}

